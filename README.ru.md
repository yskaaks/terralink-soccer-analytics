# Система Анализа Футбольных Игроков

## Введение
Этот репозиторий представляет прототип системы компьютерного зрения, предназначенной специально для анализа футбольных игроков на изображениях и видео. Он служит основополагающим доказательством концепции (Proof of Concept, PoC), которое использует последние достижения в технологии обнаружения объектов, YOLOv8, для обнаружения и отслеживания игроков, классификации их по цветам команд и отображения их движений на 2D представление футбольного поля. Система интегрирует три основных компонента:

- **Обнаружение и Отслеживание Игроков**: Использует мощь YOLOv8 для идентификации и следования за движениями игроков, обеспечивая основу для анализа в реальном времени и после матча.
- **Классификация Команд**: Использует сегментацию по цветам для различения команд, критический шаг для детализированной командной аналитики.
- **Гомография Поля**: Применяет извлечение ключевых точек и алгоритмы сопоставления точек с N точками (Perspective-n-Point, PnP) для точной проекции позиций игроков на макет футбольного поля.

Как исходный PoC, эта система устанавливает твердую основу для будущих улучшений. Она демонстрирует жизнеспособность и потенциал использования передовых компьютерных технологий зрения в спортивной аналитике. Будущие разработки будут сосредоточены на улучшении точности, эффективности и спектра аналитических инструментов, с целью предложить более всесторонние представления о динамике игры, производительности игроков и стратегиях команд. Этот проект является шагом к революции в том, как мы понимаем и наслаждаемся футболом, предлагая взгляд в будущее спортивной аналитики.

![Обзор Проекта](Resources/proyect_overview.gif)

## Содержание
- [Установка](#установка)
- [Использование](#использование)
- [Демо](#демо)
- [Тетради](#тетради)
- [Скрипты](#скрипты)
- [Будущие Работы](#будущие-работы)


## Установка

Чтобы настроить и запустить Систему Анализа Футбольных Игроков на вашем локальном компьютере, выполните следующие шаги:

### Предварительные Требования

- Убедитесь, что на вашей системе установлен [Anaconda](https://www.anaconda.com/products/individual) или [Miniconda](https://docs.conda.io/en/latest/miniconda.html). Эти платформы включают Conda, который необходим для создания и управления средой проекта.

### Клонирование Репозитория

Сначала клонируйте репозиторий на свой локальный компьютер, используя Git. Откройте терминал или командную строку и выполните следующую команду:

```bash
git clone git@github.com:yskaaks/soccer-analytics.git
cd soccer-players-analysis
```

Где soccer-players-analysis должен быть путем к директории, куда был клонирован репозиторий на вашем локальном компьютере.

### Создание Conda Среды

Создайте новую среду Python 3.11, выполнив:

```bash
conda create -n soccer-env python=3.11
```
### Активация Среды

Активируйте вновь созданную среду с помощью:

```bash
conda activate soccer-env
```

### Установка PyTorch

Установите PyTorch в соответствии с характеристиками вашей системы. Используйте инструмент со страницы [Get Started](https://pytorch.org/get-started/locally/) PyTorch, чтобы найти соответствующую команду для вашей конфигурации. Например, если вы используете CUDA 11.8, команда может выглядеть так:

```bash
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```
Эта установка может занять некоторое время.

### Установка Ultralytics YOLOv8

Установите пакет Ultralytics для использования YOLOv8, который также устанавливает необходимую библиотеку OpenCV:

```bash
pip install ultralytics
```

Этот шаг также может занять некоторое время.

### Тестирование Установки

Чтобы протестировать установку, перейдите в следующую директорию:

```bash
cd soccer-players-analysis/Usage/soccer-analytics/src
```
И запустите демо-скрипт:

```bash
python demo.py
```
После запуска Ultralytics будет автоматически обновлен, и затем должно быть отображено окно с сеткой 2x2 доступных выходов анализа футбола, указывающее на успешную установку.

Поздравляем! Вы успешно настроили Систему Анализа Футбольных Игроков на вашем локальном компьютере.


## Использование

Этот раздел детализирует шаги анализа видео футбольного матча с использованием Системы Анализа Футбольных Игроков. Процесс включает в себя настройку цветовых фильтров для сегментации команд, запуск анализа и обзор результатов, включая тепловые карты для обеих команд.

### Шаг 1: Переход в Директорию Исходного Кода Проекта

Откройте окно терминала и перейдите в исходную директорию проекта:

```bash
cd soccer-players-analysis/Usage/soccer-analytics/src
```

### Шаг 2: Запуск Скрипта Анализа
Выполните скрипт main.py с аргументом --input_video_path, указывающим на абсолютный путь к желаемому видеофайлу. Это обеспечивает правильное расположение и обработку видео:

```bash
python main.py --input_video_path "path/to/desired/video.mp4"
```
Замените "path/to/desired/video.mp4" на фактический путь к вашему видео.


### Шаг 3: Установка Фильтров HSV для Сегментации Команд

После запуска скрипта появится окно, в котором будут отображаться два примера кадров из видео (первый и средний кадры) вместе с ползунками для ручной настройки минимальных и максимальных значений HSV для создания пользовательских фильтров для цветов каждой команды.

#### 3.1 Сегментация Команды 1

Настройте ползунки для точной сегментации майки одной из команд, которая будет назначена как Команда 1. Как только вы останетесь довольны сегментацией, нажмите клавишу y, чтобы сохранить диапазон цветов.

#### 3.2 Сегментация Команды 2

Маска сегментации сбросится, позволяя вам установить параметры для второй команды. Настройте ползунки до достижения желаемых результатов и снова нажмите y, чтобы сохранить.

#### 3.3 Сохранение Диапазонов HSV

Диапазоны HSV для обеих команд будут сохранены в `soccer-players-analysis/Usage/soccer-analytics/outputs/(name-of-the-input-video)/hsv_ranges.txt`, что позволит использовать их в будущих анализах того же видео.

![HSV Segmentation](Resources/hsv_segmentation.gif)

### Шаг 4: Обзор Прогресса Обработки

Пока кадры обрабатываются, появится окно прогресса вместе с индикатором прогресса. В этом окне отображается сетка 2x2 с следующей информацией для каждого кадра:

- **Upper Left**:  Кадр с обнаружениями YOLOv8
- **Upper Right**: Расположение игроков на 2D макете
- **Lower Left**: Тепловая карта Команды 1
- **Lower Right**: Тепловая карта Команды 2

### Step 5: Access Final Outputs

Итоговые результаты сохраняются в `soccer-players-analysis/Usage/soccer-analytics/outputs/(name-of-the-input-video)` и включают в себя:

- **composite_video.mp4**: Композитное видео, показанное в окне обработки
- **overlay_heatmap_team_1.png**: Итоговая тепловая карта Команды 1
- **overlay_heatmap_team_2.png**: Итоговая тепловая карта Команды 2

![Heatmap example](Resources/heatmap_example.png)

Эти результаты предоставляют всесторонний визуальный анализ движений игроков и динамики команд в течение игры.

## Демо

Раздел демо предоставляет практическое руководство по запуску Системы Анализа Футбольных Игроков с помощью скрипта main.py. Этот скрипт демонстрирует возможности системы, включая обнаружение игроков, отслеживание, классификацию команд и гомографию поля, используя техники компьютерного зрения.

![Demo full](Resources/demo_analytics.gif)

### Начало Работы

Перед запуском демо убедитесь, что вы выполнили инструкции [Установки](#installation) для настройки необходимой среды и зависимостей.

### Базовое Использование Демо

Чтобы запустить демо с пользовательским видео, перейдите в директорию демо и выполните скрипт `main.py`, указав путь к вашему видео. В этом примере используются значения параметров по умолчанию, кроме пути к входному видео:


```bash
cd soccer-players-analysis/Usage/soccer-demo/src
python main.py --input_video_path "path/to/your/video.mp4"
```

Замените `path/to/your/video.mp4` на фактический путь к вашему видеофайлу.


### Расширенное Использование Демо

Для более настроенного анализа вы можете указать дополнительные параметры. Следующая команда демонстрирует, как изменить все доступные параметры, настроив анализ в соответствии с вашими конкретными требованиями:

```bash
cd soccer-players-analysis/Usage/soccer-demo/src
python main.py --input_video_path "path/to/your/video.mp4" --player_labels 2 3 --ball_labels 1 --n_classes 2 --input_layout_image "path/to/layout/image.png" --yolo_model_path "path/to/yolo/model/best.pt" --output_base_dir "path/to/outputs"
```

Убедитесь, что вы заменили пути-заполнители и значения на те, которые актуальны для вашей настройки.

### Чего Ожидать

- **Player Detection and Tracking**: Система использует YOLOv8 для обнаружения и отслеживания игроков, выделенных рамками.
- **Team Classification**: Команды классифицируются на основе цветов маек. Это визуализируется цветом рамок вокруг игроков.
- **Field Homography**: Позиции игроков отображаются на 2D макете футбольного поля, демонстрируя способность системы анализировать пространственную динамику.
- **Outputs**: Демо сохраняет различные результаты, включая обработанные видео, тепловые карты и данные отслеживания, в указанную директорию вывода

![Demo grid](Resources/demo_grid.gif)


## Notebooks

Тетради Jupyter в директории `Notebooks` направляют пользователей через использование функциональности системы для всестороннего анализа футбольных игроков:

### Object Detection
- **`inference-yolov8-player-detection.ipynb`**:  Демонстрирует процесс обнаружения футбольных игроков на изображениях с использованием предварительно обученной модели YOLOv8, обогащенный визуальными иллюстрациями.

### Object Tracking
- **`inference-yolov8-player-tracking.ipynb`**: Подробно описывает методологию отслеживания игроков в видеопоследовательностях, подчеркивая бесшовную интеграцию технологий обнаружения и отслеживания.

### Soccer Field Homography
- **`field-homography-opencv-features-v1.ipynb`**: Вводит задачу отображения гомографии футбольного поля, используя методы извлечения признаков OpenCV и автоматическое сопоставление с шаблоном футбольного поля. Эта тетрадь служит первым подходом к выравниванию позиций игроков с стандартным макетом футбольного поля, значительно улучшая тактический анализ и визуализационные возможности.

### Model Training
- **`training-yolov8-player-detection.ipynb`**: Предоставлен для справки, эта тетрадь предлагает полное руководство по обучению модели YOLOv8 с пользовательскими наборами данных, помогая пользователям улучшить производительность модели с их данными.

## Scripts

Директория `Scripts` содержит основной код, организованный в директории для конкретных функциональностей. Обновления включают улучшения процесса гомографии футбольного поля, введение продвинутых методов для выравнивания поля и позиционирования игроков.

### players-detection-yolo
Сосредоточен на обнаружении игроков с использованием YOLOv8. Обрабатывает видеовходы для идентификации игроков, рисует обнаружения и сохраняет кадры. Результаты сохраняются в outputs с поддиректориями для каждого тестового видео, содержащими обрезанные изображения для дальнейшего анализа.

  ![Object Detection Visualization](Resources/object_detection.png)

### players-number-recognition [Устарело в окончательной интеграции]
Использует `easyocr` для распознавания номеров игроков с обнаруженных кадров игроков. Этот скрипт обрабатывает изображения для извлечения текста, организуя результаты для целей идентификации. Результаты включают уверенные кадры для высокоточных распознаваний.


### players-tracking-norfair
Реализует логику отслеживания системы, используя Norfair для отслеживания объектов, интегрировано с OpenCV для обработки видео и YOLOv8 для обнаружения. Результаты включают видеофайлы и CSV с данными отслеживания.

  ![Player Tracking Demonstration](Resources/object_tracking.gif)

### Soccer Field Homography
- **`soccer-field-homography/extract-layout-points/extract_layout_points_v1.py`**:  Облегчает интерактивный выбор ключевых точек на изображениях футбольного поля, необходимых для точных преобразований гомографии.
- **`soccer-field-homography/classic-approach/src/main_v2.py`**:  Использует продвинутые техники для оценки позиции камеры и отслеживания поля, предлагая уточненный подход к выравниванию реального футбольного поля с его цифровым представлением.
- **`soccer-field-homography/classic-optimized-approach/src/main_video_v2.py`**: Оптимизирует преобразования гомографии для видеовходов, сохраняя точное выравнивание поля в динамичных сценах. Скрипт содержит класс `HomographyState` для эффективного управления параметрами преобразования, обеспечивая последовательное наложение футбольного поля на протяжении видеопоследовательностей. Этот продвинутый метод имеет ключевое значение для повышения точности и эффективности отслеживания игроков и картографирования поля в видео.

![Soccer Field Homography Example](Resources/soccer-field-homography.png)

## Future Work

Система Анализа Футбольных Игроков, находящаяся на стадии прототипа, продемонстрировала значительный потенциал в использовании компьютерного зрения для анализа футбольных игр. Будущие усовершенствования направлены на уточнение и расширение ее возможностей в следующих областях:


### Object Detection with YOLOv8
- **Улучшенное Обучение Модели**: Приоритет разработки пользовательски обученной модели YOLOv8, использующей всеобъемлющий набор данных, который различает игроков, вратарей и судей. Это усилие будет адресовать текущие ограничения, представленные предварительно обученной моделью, такие как неправильная классификация судей и мячей как игроков, путем включения большего, более разнообразного набора данных, специально адаптированного к нюансам футбольных игр.

### Field Homography
- **Подходы на Основе Глубокого Обучения**:  Интеграция продвинутых моделей глубокого обучения для гомографии поля для достижения более стабильных и точных проекций. Изучение репозиториев, таких как [sportsfield_release](https://github.com/vcg-uvic/sportsfield_release) и [tvcalib](https://github.com/mm4spa/tvcalib) предлагает многообещающие пути для улучшения. В то время как первый предлагает удобство внедрения для немедленных потребностей разработки, открытый характер и превосходная производительность второго делают его предпочтительным выбором для долгосрочной масштабируемости и распространения. Усилия будут сосредоточены на адаптации этих моделей для бесперебойной работы с последними версиями PyTorch, совместимыми с YOLOv8, обеспечивая более надежное и точное картографирование поля.

### Players Re-identification
- **Исследование и Реализация Продвинутых Моделей:**: Задача переидентификации игроков представляет собой уникальный вызов, требующий постоянных исследований и экспериментов с передовыми моделями. Первоначальные результаты указывают на архитектуры на основе трансформеров как на многообещающие решения. Будет выделено время для обзора, реализации и обучения моделей с нуля на основе наиболее актуальных и недавних исследований. Одной из таких отправных точек является работа, представленная в [this article](https://arxiv.org/abs/2206.02373) и связанном с ней [GitHub repository](https://github.com/shallowlearn/sportsreid), wпредлагающая современный подход к переидентификации спортивных игроков. Это начинание потребует значительных ресурсов GPU из-за сложной природы моделей и обширного обучения, требуемого.
